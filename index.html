<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Code Scanner with JSON Validation</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #reader { width: 300px; margin: 20px auto; }
    .matched { color: green; font-weight: bold; }
    .not-matched { color: red; font-weight: bold; }
    #qr-data { font-size: 18px; }
  </style>
</head>
<body>
  <h1>QR Code Scanner</h1>

  <button id="startBtn">Start Scanning</button>
  <button id="stopBtn" disabled>Stop Scanning</button>

  <div id="reader"></div>
  <p>Last Scanned QR Code: <span id="qr-data" class="not-matched">None</span></p>
  <p id="validation"></p>

  <script>
    let qrScanner;
    let scanning = false;
    let flatData = [];
    let scanHistory = []; // keep last 2 scans

    // Load JSON and flatten
    fetch("https://msamar25.github.io/qrcode/storage.json")
      .then(res => res.json())
      .then(data => {
        flatData = flattenJson(data);
        console.log("Flattened JSON:", flatData);
      })
      .catch(err => console.error("Failed to load storage.json:", err));

    function flattenJson(data) {
      if (data.floors) {
        let result = [];
        data.floors.forEach(floor => {
          floor.racks.forEach(rack => {
            result.push({
              floor: floor.floor,
              rack: rack.rack,
              qr: rack.qr,
              previous: rack.previous,
              next: rack.next
            });
          });
        });
        return result;
      }
      return data; // already flat
    }

    // Start scanning
    document.getElementById("startBtn").addEventListener("click", () => {
      if (!scanning) {
        qrScanner = new Html5Qrcode("reader");
        qrScanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          qrCodeSuccess,
          qrCodeError
        ).then(() => {
          scanning = true;
          document.getElementById("stopBtn").disabled = false;
          document.getElementById("startBtn").disabled = true;
        }).catch(err => {
          console.error("Camera error:", err);
          alert("⚠️ Please allow camera permission and reload.");
        });
      }
    });

    // Stop scanning
    document.getElementById("stopBtn").addEventListener("click", () => {
      if (qrScanner && scanning) {
        qrScanner.stop().then(() => {
          scanning = false;
          document.getElementById("startBtn").disabled = false;
          document.getElementById("stopBtn").disabled = true;
        }).catch(err => console.error("Stop error:", err));
      }
    });

    // Success handler
    function qrCodeSuccess(decodedText) {
      document.getElementById("qr-data").innerText = decodedText;

      // store last 2 scans
      scanHistory.push(decodedText);
      if (scanHistory.length > 2) scanHistory.shift();

      validateQR(decodedText);
    }

    function qrCodeError(errorMessage) {
      console.log("QR Error:", errorMessage);
    }

    // Validation logic
    function validateQR(scanned) {
      let record = flatData.find(item => item.qr === scanned);

      if (!record) {
        document.getElementById("qr-data").className = "not-matched";
        document.getElementById("validation").innerText = "❌ QR not found in JSON.";
        return;
      }

      // If fewer than 2 scans, just acknowledge
      if (scanHistory.length < 2) {
        document.getElementById("qr-data").className = "matched";
        document.getElementById("validation").innerHTML =
          `✅ First scans recorded.<br>
           Floor: ${record.floor}, Rack: ${record.rack}`;
        return;
      }

      // Get previous scan
      let prevScan = scanHistory[scanHistory.length - 2];
      let prevRecord = flatData.find(item => item.qr === prevScan);

      if (prevRecord) {
        if (prevRecord.next === scanned) {
          // forward sequence
          document.getElementById("qr-data").className = "matched";
          document.getElementById("validation").innerHTML =
            `✅ Correct Forward Sequence!<br>
             ${prevRecord.qr} → ${scanned}<br>
             Floor: ${record.floor}, Rack: ${record.rack}`;
        } else if (prevRecord.previous === scanned) {
          // backward sequence
          document.getElementById("qr-data").className = "matched";
          document.getElementById("validation").innerHTML =
            `✅ Correct Backward Sequence!<br>
             ${prevRecord.qr} ← ${scanned}<br>
             Floor: ${record.floor}, Rack: ${record.rack}`;
        } else {
          // wrong sequence
          document.getElementById("qr-data").className = "not-matched";
          document.getElementById("validation").innerHTML =
            `❌ Wrong Sequence!<br>
             Expected: ${prevRecord.previous || "None"} ← ${prevRecord.qr} → ${prevRecord.next || "None"}<br>
             Got: ${scanned}`;
        }
      }
    }
  </script>
</body>
</html>
